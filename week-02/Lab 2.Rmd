---
title: "Lab 2"
author: "Daniel Addo"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("week-02/treatmentComparison.R") # Function: Compare treatment means with ctrl
source("week-02/allocationUpdate.R") # Function: Update allocation probs
```

# Design 1
```{r}
design_one <- function(N_samp = 228, # Total number of participants
                       trt_n = 4, # Number of Arms
                       trt_effect = rep(0.35,4), # treatment effect for each arm 
                       alpha = 0.35,  beta = 0.65, # prior
                       n_post = 1000, # number of posterior draws
                       seed_setting = 4832 # set seed for replication
                       ){
  set.seed(seed_setting)
  # Equal allocation sample size determination
  design_option <- 1 # Specifying design option as needed later
  n_samp <- rep(N_samp/trt_n, trt_n)
  Y <- NULL
  post_y <- NULL
  for(i in 1:trt_n){
    # Definition of outcome given treatment effect within each arm
    Y[[i]] <- rbinom(n_samp[i],1,trt_effect[i])
    # Posterior draws
    post_y[[i]] <- rbeta(n_post, 
                         alpha + sum(Y[[i]]), 
                         beta + n_samp[i] - sum(Y[[i]])
                         )
  }
  # Compare treatments with control and select best treatment
  treatmentComparison(trt_n,post_y,n_samp,design_option)
}

# Test 
design_one(N_samp = 228, # Total number of participants
           trt_n = 4, # Number of Arms
           trt_effect = rep(0.35,4), # treatment effect for each arm 
           alpha = 0.35,  beta = 0.65, # prior
           n_post = 1000, # number of posterior draws
           seed_setting = 4832 # set seed for replication
           )


```

# Design 2 (With the option of Design 1)
```{r}
design_two <- function(N_samp = 228, # Total number of participants
                       trt_n = 4, # Number of Arms
                       trt_effect = rep(0.35,4), # treatment effect for each arm 
                       alpha = 0.35,  beta = 0.65, # prior
                       n_post = 1000, # number of posterior draws
                       seed_setting = 4832, # set seed for replication
                       allocation_size = 40, # Initial Sample to allocate
                       design_option = 2 # Design option 
                       ){
  set.seed(seed_setting) # Set seed
  # Condition to revert to design one:
  allocation_size <- ifelse(design_option==1, N_samp, allocation_size)
  # Compute # of interim allocation steps needed
  interim_steps <- ceiling(N_samp/allocation_size) 
  Y <- NULL # Output storage
  for(j in 1:interim_steps){
    post_y <- NULL
    post_y_all <- NULL
    # Define allocation probabilities
    if(j==1){ # First time, allocate equally across treatments
      allocation_prob <- rep(1,trt_n)/trt_n
      n_allocate <- round(allocation_prob*allocation_size)
      n_allocate[trt_n] <- allocation_size - sum(n_allocate[-trt_n])
      n_samp <- n_allocate
    }else if(j!=interim_steps){ # Allocate wrt allocation probs across treatments
      allocation_prob <- V_t_norm
      n_allocate <- round(allocation_prob*allocation_size)
      n_allocate[trt_n] <- allocation_size - sum(n_allocate[-trt_n])
      n_samp <-n_allocate+n_samp
    }else{ # Allocate remaining sample size
      allocation_prob <- V_t_norm
      n_allocate <- round(allocation_prob*(N_samp %% allocation_size))
      n_allocate[trt_n] <- (N_samp %% allocation_size) - sum(n_allocate[-trt_n])
      n_samp <-n_allocate+n_samp
    } 
  for(i in 1:trt_n){
    # Definition of outcome given treatment effect within each arm
    if(j==1){
      Y[[i]] <- rbinom(n_allocate[i],1,trt_effect[i])
    }else{
      Y[[i]] <- c(Y[[i]],rbinom(n_allocate[i],1,trt_effect[i]))
    }
    # Posterior draws from a beta distribution
    post_y[[i]] <- rbeta(n_post, 
                         alpha + sum(Y[[i]]), 
                         beta + n_samp[i] - sum(Y[[i]])
                         )
    post_y_all <- cbind(post_y_all,post_y[[i]])
  }
  # Update allocation probability after posterior draws
  V_t_norm <- allocationUpdate(post_y_all, n_samp)
  }
  
  # Compare treatments with control and select best treatment
  treatmentComparison(trt_n,post_y,n_samp,design_option)
  
}

# Test Example
design_two(N_samp = 228, # Total number of participants
           trt_n = 4, # Number of Arms
           trt_effect = rep(0.35,4), # treatment effect for each arm 
           alpha = 0.35,  beta = 0.65, # prior
           n_post = 1000, # number of posterior draws
           seed_setting = 1030, # set seed for replication
           allocation_size = 40, # Initial Sample to allocate
           design_option = 2 # Design option
           )
```
